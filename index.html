<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>TNTU Square Trainer</title>
    <style>
        :root {
            --primary: #00ffcc;
            --bg: #000000;
            --panel: #1a1a1a;
            --danger: #ff4444;
            --active: #00cc66;
        }

        body {
            margin: 0;
            padding: 0;
            background: var(--bg);
            color: #fff;
            font-family: 'Segoe UI', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- –í–ï–†–•–ù–Ø –ß–ê–°–¢–ò–ù–ê: –ö–ê–ú–ï–†–ê --- */
        #camera-section {
            flex: 1; /* –ó–∞–π–º–∞—î –≤–µ—Å—å –≤—ñ–ª—å–Ω–∏–π –ø—Ä–æ—Å—Ç—ñ—Ä –∑–≤–µ—Ä—Ö—É */
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            background: #050505;
        }

        /* –ö–≤–∞–¥—Ä–∞—Ç–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞–º–µ—Ä–∏ */
        #square-wrapper {
            position: relative;
            width: 90vw;       /* –®–∏—Ä–∏–Ω–∞ 90% –µ–∫—Ä–∞–Ω—É */
            max-width: 400px;  /* –ê–ª–µ –Ω–µ –±—ñ–ª—å—à–µ 400px */
            aspect-ratio: 1 / 1; /* –°–¢–†–û–ì–û –ö–í–ê–î–†–ê–¢ */
            border: 2px solid #333;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(0, 255, 204, 0.1);
            transition: border-color 0.3s;
        }

        #square-wrapper.recording {
            border-color: var(--danger);
            box-shadow: 0 0 30px rgba(255, 68, 68, 0.4);
        }

        /* –í—ñ–¥–µ–æ —Ç–∞ –ö–∞–Ω–≤–∞—Å —Ä–æ–∑—Ç—è–≥—É—é—Ç—å—Å—è, —â–æ–± –∑–∞–ø–æ–≤–Ω–∏—Ç–∏ –∫–≤–∞–¥—Ä–∞—Ç (Cover), –Ω–µ —Å–ø–æ—Ç–≤–æ—Ä—é—é—á–∏ –ø—Ä–æ–ø–æ—Ä—Ü—ñ—ó */
        video, canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; /* –¶–µ –ø—Ä–∏–±–∏—Ä–∞—î —Ä–æ–∑—Ç—è–≥–Ω—É—Ç—ñ—Å—Ç—å! */
            transform: scaleX(-1); /* –î–∑–µ—Ä–∫–∞–ª—å–Ω–µ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è */
        }

        /* –ù–∞–ø–∏—Å –Ω–∞–¥ –∫–∞–º–µ—Ä–æ—é */
        #prediction-overlay {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 18px;
            color: var(--primary);
            z-index: 10;
            border: 1px solid var(--primary);
        }

        /* --- –ù–ò–ñ–ù–Ø –ß–ê–°–¢–ò–ù–ê: –ú–ï–ù–Æ --- */
        #bottom-panel {
            height: auto;
            min-height: 40vh; /* –ó–∞–π–º–∞—î 40% –µ–∫—Ä–∞–Ω—É –∑–Ω–∏–∑—É */
            background: var(--panel);
            border-top: 2px solid var(--primary);
            border-radius: 25px 25px 0 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }

        h2 { margin: 0; font-size: 16px; color: #888; text-transform: uppercase; letter-spacing: 1px; }

        /* –°—ñ—Ç–∫–∞ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∑–∞–ø–∏—Å—É (2 –∫–æ–ª–æ–Ω–∫–∏) */
        .grid-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        button {
            background: #2a2a2a;
            border: 1px solid #444;
            color: var(--primary);
            padding: 15px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        button:active { transform: scale(0.98); }
        button.record-btn:active { background: var(--danger); color: #fff; border-color: var(--danger); }
        
        button:disabled { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; }

        /* –ö–Ω–æ–ø–∫–∏ –¥—ñ–π (Train, Save) */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }
        
        .action-btn {
            flex: 1;
            background: #004433;
            border-color: var(--primary);
            color: #fff;
            text-align: center;
            justify-content: center;
        }
        
        .action-btn:hover { background: var(--primary); color: #000; }

        .count-badge {
            background: #000;
            padding: 2px 8px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
        }

        #status-log {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-top: 5px;
            font-family: monospace;
        }

    </style>

    <!-- –ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js" crossorigin="anonymous"></script>
</head>
<body>

    <!-- –í–ï–†–•: –ö–∞–º–µ—Ä–∞ (–ö–≤–∞–¥—Ä–∞—Ç–Ω–∞) -->
    <div id="camera-section">
        <div id="square-wrapper">
            <div id="prediction-overlay">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è...</div>
            <video id="video" playsinline></video>
            <canvas id="output"></canvas>
        </div>
    </div>

    <!-- –ù–ò–ó: –ú–µ–Ω—é –∫–µ—Ä—É–≤–∞–Ω–Ω—è -->
    <div id="bottom-panel">
        
        <!-- –°–µ–∫—Ü—ñ—è –∑–∞–ø–∏—Å—É -->
        <div>
            <h2>1. –ó–±—ñ—Ä –¥–∞–Ω–∏—Ö (—É—Ç—Ä–∏–º—É–π –∫–Ω–æ–ø–∫—É)</h2>
            <div class="grid-buttons" style="margin-top: 10px;">
                <button class="record-btn" onmousedown="startRec(0)" onmouseup="stopRec()" ontouchstart="startRec(0)" ontouchend="stopRec()">
                    IDLE <span id="c0" class="count-badge">0</span>
                </button>
                <button class="record-btn" onmousedown="startRec(1)" onmouseup="stopRec()" ontouchstart="startRec(1)" ontouchend="stopRec()">
                    GRAB <span id="c1" class="count-badge">0</span>
                </button>
                <button class="record-btn" onmousedown="startRec(2)" onmouseup="stopRec()" ontouchstart="startRec(2)" ontouchend="stopRec()">
                    ROTATE <span id="c2" class="count-badge">0</span>
                </button>
                <button class="record-btn" onmousedown="startRec(3)" onmouseup="stopRec()" ontouchstart="startRec(3)" ontouchend="stopRec()">
                    ZOOM <span id="c3" class="count-badge">0</span>
                </button>
            </div>
            <div style="text-align: right; margin-top: 5px;">
                <button onclick="clearAll()" style="padding: 5px 10px; font-size: 10px; width: auto; display: inline-block; background: transparent; border: 1px solid #444; color: #666;">–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ</button>
            </div>
        </div>

        <!-- –°–µ–∫—Ü—ñ—è –¥—ñ–π -->
        <div>
            <h2>2. –ù–∞–≤—á–∞–Ω–Ω—è —Ç–∞ –ï–∫—Å–ø–æ—Ä—Ç</h2>
            <div id="status-log">–ì–æ—Ç–æ–≤–æ –¥–æ —Ä–æ–±–æ—Ç–∏</div>
            <div class="action-buttons">
                <button class="action-btn" id="btn-train" onclick="train()">üöÄ –ù–∞–≤—á–∏—Ç–∏</button>
                <button class="action-btn" id="btn-save" onclick="download()" disabled>üíæ –°–∫–∞—á–∞—Ç–∏</button>
            </div>
        </div>
    </div>

<script>
    // --- –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø ---
    const CLASSES = ['Idle', 'Grab', 'Rotate', 'Zoom'];
    const wrapper = document.getElementById('square-wrapper');
    const predOverlay = document.getElementById('prediction-overlay');
    const statusLog = document.getElementById('status-log');
    
    // --- –°–¢–ê–ù ---
    let isRecording = false;
    let currentLabel = -1;
    let data = { inputs: [], labels: [] };
    let counts = [0, 0, 0, 0];
    let model = null;
    let isTraining = false;
    
    // –Ü—Å—Ç–æ—Ä—ñ—è –¥–ª—è —Å—Ç–∞–±—ñ–ª—ñ–∑–∞—Ü—ñ—ó (Smoothing)
    let history = []; 
    const HISTORY_SIZE = 5;

    // --- ELEMENT REFS ---
    const VIDEO = document.getElementById('video');
    const CANVAS = document.getElementById('output');
    const CTX = CANVAS.getContext('2d');

    // --- MEDIAPIPE INIT ---
    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 1,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });

    hands.onResults((results) => {
        // –û—á–∏—Å—Ç–∫–∞ —ñ –º–∞–ª—é–≤–∞–Ω–Ω—è –≤—ñ–¥–µ–æ
        CTX.clearRect(0, 0, CANVAS.width, CANVAS.height);
        
        // –í–∞–∂–ª–∏–≤–∏–π –º–æ–º–µ–Ω—Ç: –º–∏ –º–∞–ª—é—î–º–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –Ω–∞ –≤–µ—Å—å –∫–≤–∞–¥—Ä–∞—Ç
        // MediaPipe –ø–æ–≤–µ—Ä—Ç–∞—î –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è. Video –µ–ª–µ–º–µ–Ω—Ç –º–∞—î object-fit: cover.
        // –©–æ–± landmarks –∑–±—ñ–≥–∞–ª–∏—Å—è, –º–∏ –º–∞–ª—é—î–º–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –Ω–∞ –≤–µ—Å—å canvas.
        CTX.drawImage(results.image, 0, 0, CANVAS.width, CANVAS.height);

        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const lm = results.multiHandLandmarks[0];
            
            // –ú–∞–ª—é—î–º–æ —Å–∫–µ–ª–µ—Ç
            drawConnectors(CTX, lm, HAND_CONNECTIONS, {color: '#00ffcc', lineWidth: 3});
            drawLandmarks(CTX, lm, {color: '#ff0000', lineWidth: 1, radius: 4});

            // –õ–æ–≥—ñ–∫–∞ –∑–∞–ø–∏—Å—É –∞–±–æ –ø–µ—Ä–µ–¥–±–∞—á–µ–Ω–Ω—è
            if (isRecording) {
                record(lm);
                wrapper.classList.add('recording');
                predOverlay.innerText = "–ó–ê–ü–ò–°: " + CLASSES[currentLabel];
                predOverlay.style.color = "#ff4444";
                predOverlay.style.borderColor = "#ff4444";
            } else {
                wrapper.classList.remove('recording');
                if (model && !isTraining) {
                    predict(lm);
                } else {
                    predOverlay.innerText = "–†—É–∫–∞ –≤–∏—è–≤–ª–µ–Ω–∞";
                    predOverlay.style.color = "#00ffcc";
                    predOverlay.style.borderColor = "#00ffcc";
                }
            }
        } else {
            predOverlay.innerText = "–ü–æ–∫–∞–∂—ñ—Ç—å —Ä—É–∫—É";
            predOverlay.style.color = "#888";
            predOverlay.style.borderColor = "#444";
        }
    });

    // --- CAMERA INIT ---
    const camera = new Camera(VIDEO, {
        onFrame: async () => { await hands.send({image: VIDEO}); },
        width: 640,  // –í–Ω—É—Ç—Ä—ñ—à–Ω—è —Ä–æ–∑–¥—ñ–ª—å–Ω–∞ –∑–¥–∞—Ç–Ω—ñ—Å—Ç—å (–Ω–µ –≤–ø–ª–∏–≤–∞—î –Ω–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è)
        height: 480
    });
    camera.start();

    // --- DATA PROCESSING ---
    function processLandmarks(landmarks) {
        const wrist = landmarks[0];
        const flat = [];
        let max = 0;
        for (let p of landmarks) {
            let x = p.x - wrist.x;
            let y = p.y - wrist.y;
            let z = p.z - wrist.z;
            flat.push(x, y, z);
            max = Math.max(max, Math.abs(x), Math.abs(y), Math.abs(z));
        }
        return flat.map(v => v / (max + 1e-6));
    }

    // --- RECORDING ---
    // –î–æ–¥–∞–≤ –ø—ñ–¥—Ç—Ä–∏–º–∫—É Touch –ø–æ–¥—ñ–π –¥–ª—è –º–æ–±—ñ–ª–æ–∫
    function startRec(id) { 
        if(isTraining) return;
        isRecording = true; 
        currentLabel = id; 
        // –í—ñ–±—Ä–∞—Ü—ñ—è –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω—ñ –ø—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ
        if(navigator.vibrate) navigator.vibrate(50);
    }
    function stopRec() { isRecording = false; }

    function record(lm) {
        data.inputs.push(processLandmarks(lm));
        data.labels.push(currentLabel);
        counts[currentLabel]++;
        document.getElementById(`c${currentLabel}`).innerText = counts[currentLabel];
    }

    function clearAll() {
        data = { inputs: [], labels: [] };
        counts = [0,0,0,0];
        for(let i=0; i<4; i++) document.getElementById(`c${i}`).innerText = 0;
        if(model) { model.dispose(); model = null; }
        document.getElementById('btn-save').disabled = true;
        statusLog.innerText = "–î–∞–Ω—ñ –æ—á–∏—â–µ–Ω–æ";
    }

    // --- TRAINING ---
    async function train() {
        if (data.inputs.length < 10) { alert("–ó–±–µ—Ä—ñ—Ç—å —Ö–æ—á–∞ –± –ø–æ 10 –ø—Ä–∏–∫–ª–∞–¥—ñ–≤!"); return; }
        
        isTraining = true;
        document.getElementById('btn-train').disabled = true;
        statusLog.innerText = "–ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–∏—Ö...";

        const inputs = tf.tensor2d(data.inputs);
        const labels = tf.oneHot(tf.tensor1d(data.labels, 'int32'), 4);

        model = tf.sequential();
        model.add(tf.layers.dense({units: 64, activation: 'relu', inputShape: [63]}));
        model.add(tf.layers.dropout({rate: 0.2}));
        model.add(tf.layers.dense({units: 32, activation: 'relu'}));
        model.add(tf.layers.dense({units: 4, activation: 'softmax'}));

        model.compile({optimizer: 'adam', loss: 'categoricalCrossentropy', metrics: ['accuracy']});

        statusLog.innerText = "–ù–∞–≤—á–∞–Ω–Ω—è...";
        
        await model.fit(inputs, labels, {
            epochs: 50,
            batchSize: 16,
            callbacks: {
                onEpochEnd: (e, l) => {
                    if (e % 5 === 0) statusLog.innerText = `–ï–ø–æ—Ö–∞ ${e}: –¢–æ—á–Ω—ñ—Å—Ç—å ${(l.acc*100).toFixed(0)}%`;
                }
            }
        });

        isTraining = false;
        statusLog.innerText = "–ù–∞–≤—á–∞–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ! –ú–æ–∂–Ω–∞ —Ç–µ—Å—Ç—É–≤–∞—Ç–∏.";
        document.getElementById('btn-train').disabled = false;
        document.getElementById('btn-save').disabled = false;
        inputs.dispose(); labels.dispose();
    }

    // --- PREDICTION ---
    function predict(lm) {
        tf.tidy(() => {
            const input = tf.tensor2d([processLandmarks(lm)]);
            const pred = model.predict(input);
            const idx = pred.argMax(1).dataSync()[0];
            const conf = pred.dataSync()[idx];

            // –°—Ç–∞–±—ñ–ª—ñ–∑–∞—Ü—ñ—è (Smoothing)
            history.push(idx);
            if(history.length > HISTORY_SIZE) history.shift();
            
            // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –Ω–∞–π—á–∞—Å—Ç—ñ—à–∏–π –∫–ª–∞—Å –≤ —ñ—Å—Ç–æ—Ä—ñ—ó
            const counts = {};
            history.forEach(h => counts[h] = (counts[h] || 0) + 1);
            const stableIdx = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);

            const labelName = CLASSES[stableIdx];
            
            // –û–Ω–æ–≤–ª—é—î–º–æ UI
            predOverlay.innerText = `${labelName} ${(conf*100).toFixed(0)}%`;
            predOverlay.style.color = conf > 0.8 ? "#00ffcc" : "#ffff00";
            predOverlay.style.borderColor = conf > 0.8 ? "#00ffcc" : "#ffff00";
        });
    }

    // --- DOWNLOAD ---
    async function download() {
        await model.save('downloads://gesture-model');
        statusLog.innerText = "–§–∞–π–ª–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ. –ü–µ—Ä–µ–º—ñ—Å—Ç—ñ—Ç—å —ó—Ö —É –ø–∞–ø–∫—É –ø—Ä–æ—î–∫—Ç—É.";
    }
</script>
</body>
</html>

